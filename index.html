<!doctype html>
<html lang="en" class="h-full">
<head>
  <meta charset="UTF-8" />
  <title>ChromaSnap</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans:wght@300;400;500;600&family=IBM+Plex+Mono&display=swap" rel="stylesheet">

  <style>
    * { font-family: 'IBM Plex Sans', sans-serif; }
    .mono { font-family: 'IBM Plex Mono', monospace; }
    .analysis-canvas { cursor: crosshair; }

    #analysis-image {
      pointer-events: auto;
    }

    #markers-container {
      pointer-events: none;
    }

    .color-marker {
      position: absolute;
      width: 22px;
      height: 22px;
      border-radius: 50%;
      border: 2px solid #111;
      transform: translate(-50%, -50%);
      box-shadow: 0 0 0 2px white, 0 4px 10px rgba(0,0,0,.15);
      pointer-events: none;
    }

    .color-marker::after {
      content: attr(data-index);
      position: absolute;
      top: -18px;
      left: 50%;
      transform: translateX(-50%);
      font-size: 10px;
      background: #111;
      color: #fff;
      padding: 1px 6px;
      border-radius: 4px;
    }

    .fade-in { animation: fade .25s ease-out; }
    @keyframes fade {
      from { opacity: 0; transform: translateY(6px); }
      to { opacity: 1; transform: translateY(0); }
    }
  </style>
</head>

<body class="h-full bg-slate-100 text-gray-900">

<!-- LANDING -->
<div id="landing" class="h-full flex items-center justify-center">
  <div class="text-center space-y-6">
    <div class="w-20 h-20 mx-auto rounded-full bg-indigo-500 flex items-center justify-center text-white text-3xl font-bold">
      CS
    </div>
    <h1 class="text-3xl font-semibold">ChromaSnap</h1>
    <p class="text-gray-500">
      Rapid test strip concentration analyzer
    </p>
    <button onclick="startApp()"
      class="px-8 py-3 rounded-xl bg-indigo-600 text-white font-medium shadow">
      Start Analysis
    </button>
  </div>
</div>

<!-- APP -->
<div id="app" class="hidden h-full flex flex-col">

<header class="bg-white border-b px-6 py-4">
  <div class="max-w-7xl mx-auto flex justify-between items-center">
    <div>
      <h2 id="app-title" class="font-semibold text-lg">ChromaSnap</h2>
      <p id="app-subtitle" class="text-xs text-gray-400"></p>
    </div>
    <button onclick="goBack()" class="text-sm text-gray-500">← Back</button>
  </div>
</header>

<main class="flex-1 max-w-7xl mx-auto w-full px-6 py-6 grid grid-cols-1 lg:grid-cols-3 gap-6">

<section class="lg:col-span-2 space-y-4">

<div class="grid grid-cols-2 gap-3">
  <button id="strip-mode-btn" class="p-4 rounded-xl border-2 border-indigo-500 bg-white">
    <div id="strip-mode-title" class="font-medium">Strip Mode</div>
    <div class="text-xs text-gray-400">Multi-point sampling</div>
  </button>
  <button id="lamp-mode-btn" class="p-4 rounded-xl border bg-white">
    <div id="lamp-mode-title" class="font-medium text-gray-500">LAMP Mode</div>
    <div class="text-xs text-gray-400">Pre / Post comparison</div>
  </button>
</div>

<div class="bg-white rounded-xl border overflow-hidden">
  <div class="flex justify-between px-4 py-2 border-b">
    <span class="text-sm font-medium">Analysis Canvas</span>
    <div class="space-x-2">
      <button id="clear-markers-btn" class="text-xs hidden">Clear</button>
      <button id="reset-btn" class="text-xs hidden">Reset</button>
    </div>
  </div>

  <div id="canvas-area" class="relative min-h-[420px] bg-slate-50 flex items-center justify-center">
    <div id="upload-prompt" class="text-center">
      <input type="file" id="image-input" hidden accept="image/*">
      <label for="image-input" class="cursor-pointer">
        ⬆️ Upload Image
      </label>
    </div>

    <div id="image-container" class="hidden relative w-full">
      <img id="analysis-image" class="analysis-canvas w-full">
      <div id="markers-container" class="absolute inset-0"></div>
    </div>
  </div>
</div>

<div class="bg-white rounded-xl border px-4 py-3">
  <div class="flex gap-3">
    <div id="step-number"
      class="w-6 h-6 rounded-full bg-indigo-500 text-white text-xs flex items-center justify-center">
      1
    </div>
    <div>
      <p id="instruction-text" class="text-sm"></p>
      <p id="instruction-hint" class="text-xs text-gray-400"></p>
    </div>
  </div>
</div>

</section>

<aside class="space-y-4">

<div id="lamp-selection-panel" class="hidden bg-white rounded-xl border p-4">
  <h3 class="text-sm font-medium mb-3">Color Selection</h3>
  <div class="flex gap-4">
    <div>
      <div id="pre-color-display" class="w-10 h-10 border rounded mb-1"></div>
      <div id="pre-color-value" class="mono text-xs text-gray-400">Not selected</div>
    </div>
    <div>
      <div id="post-color-display" class="w-10 h-10 border rounded mb-1"></div>
      <div id="post-color-value" class="mono text-xs text-gray-400">Not selected</div>
    </div>
  </div>
</div>

<div class="bg-white rounded-xl border">
  <div class="px-4 py-3 border-b">
    <h3 id="result-header" class="text-sm font-medium">Results</h3>
  </div>
  <div id="results-container" class="p-4">
    <div id="no-results" class="text-sm text-gray-400 text-center">No analysis data</div>
    <div id="results-list" class="space-y-3 hidden"></div>
  </div>
</div>

<div id="summary-panel" class="hidden bg-white rounded-xl border p-4">
  <h3 class="text-sm font-medium mb-3">Summary</h3>
  <div id="summary-content" class="space-y-2 text-sm"></div>
</div>

</aside>
</main>
</div>

<!-- JS -->
<script>
 // Default configuration
    const defaultConfig = {
      app_title: 'ChromaSnap',
      app_subtitle: 'Quantitative color detection for diagnostic strip analysis and LAMP assay interpretation',
      strip_mode_title: 'Strip Detection Mode',
      lamp_mode_title: 'LAMP Color Change Detection',
      result_header: 'Analysis Results',
      primary_color: '#111827',
      secondary_color: '#f9fafb',
      text_color: '#374151',
      accent_color: '#059669',
      border_color: '#e5e7eb',
      font_family: 'IBM Plex Sans'
    };

    // Application state
    let currentMode = 'strip';
    let imageLoaded = false;
    let markers = [];
    let lampSelections = { pre: null, post: null };
    let selectingLampPhase = 'pre';
    let imageContext = null;
    let analysisResults = [];

    // Color classification data
    const colorCategories = {
      pink: { hueRange: [330, 360], name: 'Pink', altRange: [0, 10] },
      red: { hueRange: [0, 15], name: 'Red' },
      orange: { hueRange: [15, 45], name: 'Orange' },
      yellow: { hueRange: [45, 70], name: 'Yellow' },
      lime: { hueRange: [70, 90], name: 'Lime Green' },
      green: { hueRange: [90, 150], name: 'Green' },
      cyan: { hueRange: [150, 195], name: 'Cyan' },
      blue: { hueRange: [195, 255], name: 'Blue' },
      purple: { hueRange: [255, 290], name: 'Purple' },
      magenta: { hueRange: [290, 330], name: 'Magenta' }
    };

    // DOM Elements
    const elements = {
      appTitle: document.getElementById('app-title'),
      appSubtitle: document.getElementById('app-subtitle'),
      stripModeBtn: document.getElementById('strip-mode-btn'),
      lampModeBtn: document.getElementById('lamp-mode-btn'),
      stripModeTitle: document.getElementById('strip-mode-title'),
      lampModeTitle: document.getElementById('lamp-mode-title'),
      imageInput: document.getElementById('image-input'),
      uploadPrompt: document.getElementById('upload-prompt'),
      imageContainer: document.getElementById('image-container'),
      analysisImage: document.getElementById('analysis-image'),
      markersContainer: document.getElementById('markers-container'),
      canvasArea: document.getElementById('canvas-area'),
      stepNumber: document.getElementById('step-number'),
      instructionText: document.getElementById('instruction-text'),
      instructionHint: document.getElementById('instruction-hint'),
      clearMarkersBtn: document.getElementById('clear-markers-btn'),
      resetBtn: document.getElementById('reset-btn'),
      lampSelectionPanel: document.getElementById('lamp-selection-panel'),
      preColorDisplay: document.getElementById('pre-color-display'),
      postColorDisplay: document.getElementById('post-color-display'),
      preColorValue: document.getElementById('pre-color-value'),
      postColorValue: document.getElementById('post-color-value'),
      resultHeader: document.getElementById('result-header'),
      noResults: document.getElementById('no-results'),
      resultsList: document.getElementById('results-list'),
      summaryPanel: document.getElementById('summary-panel'),
      summaryContent: document.getElementById('summary-content')
    };

    // Initialize SDK
    function initializeApp() {
      if (window.elementSdk) {
        window.elementSdk.init({
          defaultConfig,
          onConfigChange: applyConfig,
          mapToCapabilities: (config) => ({
            recolorables: [
              {
                get: () => config.primary_color || defaultConfig.primary_color,
                set: (value) => window.elementSdk.setConfig({ primary_color: value })
              },
              {
                get: () => config.secondary_color || defaultConfig.secondary_color,
                set: (value) => window.elementSdk.setConfig({ secondary_color: value })
              },
              {
                get: () => config.text_color || defaultConfig.text_color,
                set: (value) => window.elementSdk.setConfig({ text_color: value })
              },
              {
                get: () => config.accent_color || defaultConfig.accent_color,
                set: (value) => window.elementSdk.setConfig({ accent_color: value })
              },
              {
                get: () => config.border_color || defaultConfig.border_color,
                set: (value) => window.elementSdk.setConfig({ border_color: value })
              }
            ],
            borderables: [],
            fontEditable: {
              get: () => config.font_family || defaultConfig.font_family,
              set: (value) => window.elementSdk.setConfig({ font_family: value })
            },
            fontSizeable: undefined
          }),
          mapToEditPanelValues: (config) => new Map([
            ['app_title', config.app_title || defaultConfig.app_title],
            ['app_subtitle', config.app_subtitle || defaultConfig.app_subtitle],
            ['strip_mode_title', config.strip_mode_title || defaultConfig.strip_mode_title],
            ['lamp_mode_title', config.lamp_mode_title || defaultConfig.lamp_mode_title],
            ['result_header', config.result_header || defaultConfig.result_header]
          ])
        });
      }
      
      setupEventListeners();
      applyConfig(defaultConfig);
    }

    // Apply configuration to UI
    async function applyConfig(config) {
      const c = { ...defaultConfig, ...config };
      
      // Apply text content
      elements.appTitle.textContent = c.app_title;
      elements.appSubtitle.textContent = c.app_subtitle;
      elements.stripModeTitle.textContent = c.strip_mode_title;
      elements.lampModeTitle.textContent = c.lamp_mode_title;
      elements.resultHeader.textContent = c.result_header;

      // Apply colors
      document.body.style.backgroundColor = c.secondary_color;
      document.body.style.color = c.text_color;
      
      // Apply font
      const fontStack = `${c.font_family}, -apple-system, BlinkMacSystemFont, sans-serif`;
      document.body.style.fontFamily = fontStack;
      
      // Update primary elements
      elements.appTitle.style.color = c.primary_color;
      
      // Update active mode button styling
      updateModeButtonStyles(c);
    }

    function updateModeButtonStyles(config) {
         const c = config || defaultConfig;

        if (currentMode === 'strip') {
            elements.stripModeBtn.style.borderColor = c.primary_color;
            elements.lampModeBtn.style.borderColor = c.border_color;
        } else {
            elements.lampModeBtn.style.borderColor = c.primary_color;
            elements.stripModeBtn.style.borderColor = c.border_color;
        }
    }


    // Event Listeners
    function setupEventListeners() {
      elements.stripModeBtn.addEventListener('click', () => setMode('strip'));
      elements.lampModeBtn.addEventListener('click', () => setMode('lamp'));
      elements.imageInput.addEventListener('change', handleImageUpload);
      elements.analysisImage.addEventListener('click', handleImageClick);
      elements.clearMarkersBtn.addEventListener('click', clearMarkers);
      elements.resetBtn.addEventListener('click', resetAnalysis);
    }

    // Mode switching
    function setMode(mode) {
      currentMode = mode;
      updateModeButtonStyles();
      
      // Update UI for mode
      if (mode === 'lamp') {
        elements.lampSelectionPanel.classList.remove('hidden');
        elements.stripModeTitle.classList.remove('text-gray-900');
        elements.stripModeTitle.classList.add('text-gray-600');
        elements.lampModeTitle.classList.remove('text-gray-600');
        elements.lampModeTitle.classList.add('text-gray-900');
        elements.lampModeBtn.querySelector('.text-xs').classList.remove('text-gray-400');
        elements.lampModeBtn.querySelector('.text-xs').classList.add('text-gray-500');
        elements.stripModeBtn.querySelector('.text-xs').classList.remove('text-gray-500');
        elements.stripModeBtn.querySelector('.text-xs').classList.add('text-gray-400');
      } else {
        elements.lampSelectionPanel.classList.add('hidden');
        elements.stripModeTitle.classList.add('text-gray-900');
        elements.stripModeTitle.classList.remove('text-gray-600');
        elements.lampModeTitle.classList.add('text-gray-600');
        elements.lampModeTitle.classList.remove('text-gray-900');
        elements.stripModeBtn.querySelector('.text-xs').classList.add('text-gray-500');
        elements.stripModeBtn.querySelector('.text-xs').classList.remove('text-gray-400');
        elements.lampModeBtn.querySelector('.text-xs').classList.add('text-gray-400');
        elements.lampModeBtn.querySelector('.text-xs').classList.remove('text-gray-500');
      }
      
      clearMarkers();
      resetLampSelections();
      updateInstructions();
    }

    // Image handling
    function handleImageUpload(e) {
      const file = e.target.files[0];
      if (!file) return;
      
      const reader = new FileReader();
      reader.onload = (event) => {
        const img = new Image();
        img.onload = () => {
          elements.analysisImage.src = event.target.result;
          elements.uploadPrompt.classList.add('hidden');
          elements.imageContainer.classList.remove('hidden');
          elements.clearMarkersBtn.classList.remove('hidden');
          elements.resetBtn.classList.remove('hidden');
          imageLoaded = true;
          
          // Create canvas for color extraction
          const canvas = document.createElement('canvas');
          canvas.width = img.width;
          canvas.height = img.height;
          imageContext = canvas.getContext('2d');
          imageContext.drawImage(img, 0, 0);
          
          updateInstructions();
        };
        img.src = event.target.result;
      };
      reader.readAsDataURL(file);
    }

    // Handle click on image
    function handleImageClick(e) {
      if (!imageLoaded || !imageContext) return;
      
      const rect = elements.analysisImage.getBoundingClientRect();
      const scaleX = elements.analysisImage.naturalWidth / rect.width;
      const scaleY = elements.analysisImage.naturalHeight / rect.height;
      
      const x = (e.clientX - rect.left) * scaleX;
      const y = (e.clientY - rect.top) * scaleY;
      
      // Get color at click position (average 3x3 area)
      const color = getAverageColor(x, y, 3);
      
      if (currentMode === 'strip') {
        addStripMarker(e.clientX - rect.left, e.clientY - rect.top, color);
      } else {
        addLampSelection(e.clientX - rect.left, e.clientY - rect.top, color);
      }
    }

    // Get average color from image
    function getAverageColor(x, y, size) {
      const half = Math.floor(size / 2);
      let r = 0, g = 0, b = 0, count = 0;
      
      for (let dx = -half; dx <= half; dx++) {
        for (let dy = -half; dy <= half; dy++) {
          const px = Math.round(x + dx);
          const py = Math.round(y + dy);
          
          if (px >= 0 && px < imageContext.canvas.width && py >= 0 && py < imageContext.canvas.height) {
            const pixel = imageContext.getImageData(px, py, 1, 1).data;
            r += pixel[0];
            g += pixel[1];
            b += pixel[2];
            count++;
          }
        }
      }
      
      return {
        r: Math.round(r / count),
        g: Math.round(g / count),
        b: Math.round(b / count)
      };
    }

    // Add marker for strip mode
    function addStripMarker(x, y, color) {
      const index = markers.length + 1;
      
      const marker = document.createElement('div');
      marker.className = 'color-marker fade-in';
      marker.style.left = `${x}px`;
      marker.style.top = `${y}px`;
      marker.style.backgroundColor = `rgb(${color.r}, ${color.g}, ${color.b})`;
      marker.setAttribute('data-index', index);
      
      elements.markersContainer.appendChild(marker);
      markers.push({ x, y, color, element: marker });
      
      // Analyze and add result
      const result = analyzeColor(color, index);
      analysisResults.push(result);
      renderResults();
      updateInstructions();
    }

    // Add LAMP selection
    function addLampSelection(x, y, color) {
      const colorHex = `rgb(${color.r}, ${color.g}, ${color.b})`;
      const colorHexCode = rgbToHex(color.r, color.g, color.b);
      
      if (selectingLampPhase === 'pre') {
        lampSelections.pre = { x, y, color };
        elements.preColorDisplay.style.backgroundColor = colorHex;
        elements.preColorDisplay.style.borderStyle = 'solid';
        elements.preColorDisplay.innerHTML = '';
        elements.preColorValue.textContent = colorHexCode;
        elements.preColorValue.classList.remove('text-gray-400');
        elements.preColorValue.classList.add('text-gray-600');
        
        // Add marker
        clearMarkers();
        const marker = document.createElement('div');
        marker.className = 'color-marker fade-in';
        marker.style.left = `${x}px`;
        marker.style.top = `${y}px`;
        marker.style.backgroundColor = colorHex;
        marker.setAttribute('data-index', 'Pre');
        elements.markersContainer.appendChild(marker);
        
        selectingLampPhase = 'post';
      } else {
        lampSelections.post = { x, y, color };
        elements.postColorDisplay.style.backgroundColor = colorHex;
        elements.postColorDisplay.style.borderStyle = 'solid';
        elements.postColorDisplay.innerHTML = '';
        elements.postColorValue.textContent = colorHexCode;
        elements.postColorValue.classList.remove('text-gray-400');
        elements.postColorValue.classList.add('text-gray-600');
        
        // Add post marker
        const marker = document.createElement('div');
        marker.className = 'color-marker fade-in';
        marker.style.left = `${x}px`;
        marker.style.top = `${y}px`;
        marker.style.backgroundColor = colorHex;
        marker.setAttribute('data-index', 'Post');
        elements.markersContainer.appendChild(marker);
        
        // Analyze LAMP result
        analyzeLampResult();
        selectingLampPhase = 'pre';
      }
      
      updateInstructions();
    }

    // Analyze single color
    function analyzeColor(color, index) {
      const hsv = rgbToHsv(color.r, color.g, color.b);
      const category = classifyColor(hsv);
      const intensity = getIntensityLevel(hsv);
      const status = determineStatus(category, intensity);
      
      return {
        index,
        color,
        category,
        intensity,
        status,
        hsv
      };
    }

    // Analyze LAMP color change
    function analyzeLampResult() {
      if (!lampSelections.pre || !lampSelections.post) return;
      
      const preHsv = rgbToHsv(lampSelections.pre.color.r, lampSelections.pre.color.g, lampSelections.pre.color.b);
      const postHsv = rgbToHsv(lampSelections.post.color.r, lampSelections.post.color.g, lampSelections.post.color.b);
      
      const preCategory = classifyColor(preHsv);
      const postCategory = classifyColor(postHsv);
      
      // Calculate color change magnitude
      const hueDiff = Math.abs(postHsv.h - preHsv.h);
      const satDiff = Math.abs(postHsv.s - preHsv.s);
      const valDiff = Math.abs(postHsv.v - preHsv.v);
      
      const totalChange = hueDiff + (satDiff * 100) + (valDiff * 100);
      
      let status, changeLevel;
      if (totalChange > 80) {
        status = 'Positive';
        changeLevel = 'High';
      } else if (totalChange > 40) {
        status = 'Positive';
        changeLevel = 'Medium';
      } else if (totalChange > 20) {
        status = 'Inconclusive';
        changeLevel = 'Low';
      } else {
        status = 'Negative';
        changeLevel = 'None';
      }
      
      const concentrationData = calculateConcentration(
    lampSelections.pre.color,
    lampSelections.post.color
    );

    analysisResults = [{
    type: 'lamp',
    preColor: lampSelections.pre.color,
    postColor: lampSelections.post.color,
    preCategory,
    postCategory,
    status,
    changeLevel,
    totalChange: Math.round(totalChange),
    concentration: concentrationData.concentration,
    deltaRed: concentrationData.deltaRed,
    deltaIntensity: concentrationData.deltaIntensity
    }];

      
      renderResults();
      
    }

    // Color classification helpers
    function rgbToHsv(r, g, b) {
      r /= 255; g /= 255; b /= 255;
      const max = Math.max(r, g, b), min = Math.min(r, g, b);
      let h, s, v = max;
      const d = max - min;
      s = max === 0 ? 0 : d / max;
      
      if (max === min) {
        h = 0;
      } else {
        switch (max) {
          case r: h = (g - b) / d + (g < b ? 6 : 0); break;
          case g: h = (b - r) / d + 2; break;
          case b: h = (r - g) / d + 4; break;
        }
        h /= 6;
      }
      
      return { h: h * 360, s, v };
    }

    function rgbToHex(r, g, b) {
      return '#' + [r, g, b].map(x => x.toString(16).padStart(2, '0')).join('').toUpperCase();
    }

    function classifyColor(hsv) {
      if (hsv.s < 0.15) {
        if (hsv.v > 0.9) return 'White';
        if (hsv.v < 0.15) return 'Black';
        return 'Gray';
      }
      
      const h = hsv.h;
      for (const [key, cat] of Object.entries(colorCategories)) {
        if (h >= cat.hueRange[0] && h < cat.hueRange[1]) {
          return cat.name;
        }
        if (cat.altRange && h >= cat.altRange[0] && h < cat.altRange[1]) {
          return cat.name;
        }
      }
      return 'Unknown';
    }

    function getIntensityLevel(hsv) {
      const intensity = hsv.s * hsv.v;
      if (intensity > 0.6) return 'High';
      if (intensity > 0.3) return 'Medium';
      return 'Low';
    }

    function determineStatus(category, intensity) {
      // Simplified status determination based on common colorimetric assays
      const positiveColors = ['Pink', 'Red', 'Purple', 'Magenta', 'Yellow', 'Green'];
      const negativeColors = ['White', 'Gray', 'Blue'];
      
      if (positiveColors.includes(category) && intensity !== 'Low') {
        return 'Positive';
      } else if (negativeColors.includes(category)) {
        return 'Negative';
      }
      return 'Inconclusive';
    }

    // Render results
    function renderResults() {
      if (analysisResults.length === 0) {
        elements.noResults.classList.remove('hidden');
        elements.resultsList.classList.add('hidden');
        elements.summaryPanel.classList.add('hidden');
        return;
      }
      
      elements.noResults.classList.add('hidden');
      elements.resultsList.classList.remove('hidden');
      elements.resultsList.innerHTML = '';
      
      analysisResults.forEach(result => {
        const card = document.createElement('div');
        card.className = `result-card bg-gray-50 rounded-lg p-3 fade-in result-${result.status.toLowerCase()}`;
        
        if (result.type === 'lamp') {
          card.innerHTML = `
            <div class="flex items-center justify-between mb-2">
              <span class="text-xs font-medium text-gray-500 uppercase tracking-wide">LAMP Analysis</span>
              <span class="text-xs font-semibold px-2 py-0.5 rounded ${getStatusClass(result.status)}">${result.status}</span>
            </div>
            <div class="grid grid-cols-2 gap-2 mb-2">
              <div class="flex items-center gap-2">
                <div class="w-6 h-6 rounded" style="background: rgb(${result.preColor.r}, ${result.preColor.g}, ${result.preColor.b})"></div>
                <span class="text-xs text-gray-500">${result.preCategory}</span>
              </div>
              <div class="flex items-center gap-2">
                <div class="w-6 h-6 rounded" style="background: rgb(${result.postColor.r}, ${result.postColor.g}, ${result.postColor.b})"></div>
                <span class="text-xs text-gray-500">${result.postCategory}</span>
              </div>
            </div>
            <div class="text-xs text-gray-400">
              <span>Color Change: </span>
              <span class="font-medium text-gray-600">${result.changeLevel}</span>
            </div>
          `;
        } else {
          const colorHex = rgbToHex(result.color.r, result.color.g, result.color.b);
          card.innerHTML = `
            <div class="flex items-center justify-between mb-2">
              <span class="text-xs font-medium text-gray-500 uppercase tracking-wide">Sample ${result.index}</span>
              <span class="text-xs font-semibold px-2 py-0.5 rounded ${getStatusClass(result.status)}">${result.status}</span>
            </div>
            <div class="flex items-center gap-3">
              <div class="w-8 h-8 rounded-lg border border-gray-200" style="background: rgb(${result.color.r}, ${result.color.g}, ${result.color.b})"></div>
              <div>
                <span class="text-sm text-gray-700 block">${result.category}</span>
                <span class="text-xs text-gray-400 mono">${colorHex}</span>
              </div>
            </div>
            <div class="mt-2 text-xs text-gray-400">
              <span>Intensity: </span>
              <span class="font-medium text-gray-600">${result.intensity}</span>
            </div>
          `;
        }
        
        elements.resultsList.appendChild(card);
      });
      
      // Update summary
      updateSummary();
    }

    function getStatusClass(status) {
      switch (status) {
        case 'Positive': return 'bg-emerald-100 text-emerald-700';
        case 'Negative': return 'bg-gray-100 text-gray-600';
        case 'Inconclusive': return 'bg-amber-100 text-amber-700';
        default: return 'bg-gray-100 text-gray-600';
      }
    }

    function updateSummary() {
      if (analysisResults.length === 0) {
        elements.summaryPanel.classList.add('hidden');
        return;
      }
      
      elements.summaryPanel.classList.remove('hidden');
      
      if (currentMode === 'strip') {
        const positive = analysisResults.filter(r => r.status === 'Positive').length;
        const negative = analysisResults.filter(r => r.status === 'Negative').length;
        const inconclusive = analysisResults.filter(r => r.status === 'Inconclusive').length;
        
        elements.summaryContent.innerHTML = `
          <div class="flex items-center justify-between text-sm">
            <span class="text-gray-500">Total Samples</span>
            <span class="font-medium text-gray-900">${analysisResults.length}</span>
          </div>
          <div class="flex items-center justify-between text-sm">
            <span class="text-gray-500">Positive</span>
            <span class="font-medium text-emerald-600">${positive}</span>
          </div>
          <div class="flex items-center justify-between text-sm">
            <span class="text-gray-500">Negative</span>
            <span class="font-medium text-gray-600">${negative}</span>
          </div>
          ${inconclusive > 0 ? `
          <div class="flex items-center justify-between text-sm">
            <span class="text-gray-500">Inconclusive</span>
            <span class="font-medium text-amber-600">${inconclusive}</span>
          </div>
          ` : ''}
        `;
      } else {
        const result = analysisResults[0];
        elements.summaryContent.innerHTML = `
          <div class="flex items-center justify-between text-sm">
            <span class="text-gray-500">Result</span>
            <span class="font-semibold ${result.status === 'Positive' ? 'text-emerald-600' : result.status === 'Negative' ? 'text-gray-600' : 'text-amber-600'}">${result.status}</span>
          </div>
          <div class="flex items-center justify-between text-sm">
            <span class="text-gray-500">Color Transition</span>
            <span class="font-medium text-gray-900">${result.preCategory} → ${result.postCategory}</span>
          </div>
          <div class="flex items-center justify-between text-sm">
            <span class="text-gray-500">Change Magnitude</span>
            <span class="font-medium text-gray-900">${result.changeLevel}</span>
          </div>
        `;
      }
    }

    // Update instructions
    function updateInstructions() {
      let step, text, hint;
      
      if (!imageLoaded) {
        step = '1';
        text = 'Upload an image of your test sample to begin analysis.';
        hint = 'Supported formats: PNG, JPG, JPEG';
      } else if (currentMode === 'strip') {
        if (markers.length === 0) {
          step = '2';
          text = 'Click on the color regions of each test strip to analyze.';
          hint = 'Each click samples the color at that position';
        } else {
          step = '✓';
          text = `${markers.length} sample${markers.length > 1 ? 's' : ''} analyzed. Click to add more samples.`;
          hint = 'Click "Clear Selections" to start over';
        }
      } else {
        if (!lampSelections.pre) {
          step = '2';
          text = 'Click on the pre-reaction color region.';
          hint = 'Select the initial color before the reaction';
        } else if (!lampSelections.post) {
          step = '3';
          text = 'Click on the post-reaction color region.';
          hint = 'Select the color after the reaction completed';
        } else {
          step = '✓';
          text = 'Analysis complete. Click "Clear Selections" to analyze again.';
          hint = 'Results displayed in the panel';
        }
      }
      
      elements.stepNumber.textContent = step;
      elements.instructionText.textContent = text;
      elements.instructionHint.textContent = hint;
    }

    // Clear markers
    function clearMarkers() {
      markers = [];
      elements.markersContainer.innerHTML = '';
      
      if (currentMode === 'strip') {
        analysisResults = [];
        renderResults();
      }
      
      updateInstructions();
    }

    // Reset LAMP selections
    function resetLampSelections() {
      lampSelections = { pre: null, post: null };
      selectingLampPhase = 'pre';
      
      elements.preColorDisplay.style.backgroundColor = '';
      elements.preColorDisplay.style.borderStyle = 'dashed';
      elements.preColorDisplay.innerHTML = '<span class="text-xs text-gray-400">—</span>';
      elements.preColorValue.textContent = 'Not selected';
      elements.preColorValue.classList.add('text-gray-400');
      elements.preColorValue.classList.remove('text-gray-600');
      
      elements.postColorDisplay.style.backgroundColor = '';
      elements.postColorDisplay.style.borderStyle = 'dashed';
      elements.postColorDisplay.innerHTML = '<span class="text-xs text-gray-400">—</span>';
      elements.postColorValue.textContent = 'Not selected';
      elements.postColorValue.classList.add('text-gray-400');
      elements.postColorValue.classList.remove('text-gray-600');
      
      analysisResults = [];
      renderResults();
    }

    // Full reset
    function resetAnalysis() {
      imageLoaded = false;
      imageContext = null;
      markers = [];
      analysisResults = [];
      
      elements.uploadPrompt.classList.remove('hidden');
      elements.imageContainer.classList.add('hidden');
      elements.clearMarkersBtn.classList.add('hidden');
      elements.resetBtn.classList.add('hidden');
      elements.markersContainer.innerHTML = '';
      elements.imageInput.value = '';
      
      resetLampSelections();
      renderResults();
      updateInstructions();
    }

    // Initialize
    initializeApp();

    // Calculate redness metric
// Calculate redness metric (normalized red channel)
function calculateRedness(color) {
  const sum = color.r + color.g + color.b;
  if (sum === 0) return 0;
  return color.r / sum;
}

// Calculate intensity (brightness-weighted saturation)
function calculateIntensity(color) {
  const hsv = rgbToHsv(color.r, color.g, color.b);
  return hsv.s * hsv.v; // 0 → 1
}

// Convert redness + intensity shift to concentration (ng/µL)
function calculateConcentration(preColor, postColor) {
  const preRed = calculateRedness(preColor);
  const postRed = calculateRedness(postColor);

  const preIntensity = calculateIntensity(preColor);
  const postIntensity = calculateIntensity(postColor);

  const deltaRed = postRed - preRed;
  const deltaIntensity = postIntensity - preIntensity;

  /*
    Empirical model:
    concentration ∝ redness shift × intensity amplification
    สามารถปรับค่าพวกนี้ให้ตรง assay จริงภายหลัง
  */
  const RED_SCALE = 1200;        // sensitivity ต่อ redness
  const INTENSITY_GAIN = 1 + deltaIntensity * 2;

  const concentration =
    Math.max(0, deltaRed * RED_SCALE * INTENSITY_GAIN);

  return {
    preRed,
    postRed,
    deltaRed,
    preIntensity,
    postIntensity,
    deltaIntensity,
    concentration: Number(concentration.toFixed(2)) // ng/µL
  };
}


</script>

<script>
function startApp(){
  document.getElementById('landing').classList.add('hidden')
  document.getElementById('app').classList.remove('hidden')
}
function goBack(){ location.reload() }
</script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9c1dd3aa51b44b94',t:'MTc2OTA3MjA2OC4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>

</body>
</html>
